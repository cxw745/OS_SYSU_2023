# 本科生实验报告

实验课程: 操作系统原理实验

任课教师: 刘宁

实验题目: **从实模式到保护模式**

专业名称: 计算机科学与技术

学生姓名: **陈雪玮**

学生学号: **21307387**

实验地点: 实验中心D501

实验时间: 2023.5.1

## Section 1 实验概述

* 学习C语言可变参数机制的实现方法。
  
  * 学习可变参数的原理，实现可变参数机制。
  
  * 实现可变参数后，实现一个printf函数。此后可以使用printf、gdb来debug。

* 实现内核线程。
  
  * 定义线程控制块的数据结构PCB，创建PCB。
  
  * 在PCB中放入线程执行需要的参数。
  
  * 实现基于时钟中断的RR调度算法。
  
  * 重点理解`asm_switch_thread`如何实现线程切换，体会操作系统实现并发执行的原理。

## Section 2 预备知识与实验环境

该节总结实验需要用到的基本知识，以及主机型号、代码编译工具、重要三方库的版本号信息等。

- 预备知识：x86汇编语言程序设计、Linux系统命令行工具

- 实验环境：
  
  - 虚拟机版本/处理器型号：Ubuntu18.04、i386
  
  - 代码编辑环境：Linux
  
  - 代码编译工具：makefile、gcc等
  
  - 重要三方库信息：

## Section 2 实验任务

- 实验任务1：⾃旋锁与信号量的实现
  
  - ⼦任务1—利⽤⾃旋锁和信号量实现同步
  
  - ⼦任务2—⾃实现锁机制

- 实验任务2：⽣产者-消费者问题
  
  - ⼦任务1—线程的竞争与冲突
  
  - ⼦任务2—利⽤信号量解决问题

- 实验任务3：哲学家就餐问题
  
  - ⼦任务1—简单解决⽅法
  
  - ⼦任务2—死锁应对策略

## Section 3 实验步骤与实验结果

### ------------------------- 实验任务1 -------------------------

- 任务要求：⾃旋锁与信号量的实现
  
  - ⼦任务1—利⽤⾃旋锁和信号量实现同步
  
  > 在实验6中，我们实现了⾃旋锁和信号量机制。现在，请同学们分别利⽤指导书中实现的⾃旋锁和信号量⽅法，解决实验6指导书中的“消失的芝⼠汉堡”问题，保存结果截图并说说你的总体思路。注意:请将你姓名的英⽂缩写包含在某个线程的输出信息中（⽐如，代替⺟亲或者⼉⼦），⽤作结果截图中的个⼈信息表征。
  
  - ⼦任务2—⾃实现锁机制
  
  > 实验6教程中使⽤了原⼦指令 xchg 来实现⾃旋锁。但这种⽅法并不是唯⼀的。例如，x86指令中提供了另外⼀个原⼦指令 bts 和 lock 前缀等，这些指令也可以⽤来实现锁机制。现在，同学们需要结合⾃⼰所学的知识，实现⼀个与指导书实现⽅式不同的锁机制。最后，尝试⽤你实现的锁机制解决“消失的芝⼠汉堡”问题，保存结果截图并说说你的总体思路。
  
             

- 思路分析：

- 实验步骤：

- 实验结果展示：通过执行前述代码，可得下图结果。

### ------------------------- 实验任务2 -------------------------

- 任务要求：⽣产者-消费者问题
  
  - 总要求与问题场景
  
  > 1. 同学们请在下述问题场景A或问题场景B中选择⼀个，然后在实验6教程的代码环境下创建多个线程来模拟你选择的问题场景。同学们需⾃⾏决定每个线程的执⾏次数，以⽅便观察临界资源变化为⾸要原则。  
  > 
  > 2. 请将你学号的后4位包含在其中⼀个线程的输出信息中，⽤作结果截图中的个⼈信息表征。例如，学号为 21319527 的同学选择问题A，并扮演服务⽣A，则服务⽣A放⼊1块蛋糕时，程序输出 "`Waiter-A 9527 put a piece of matcha cake in the plate.`"
  > -  问题场景A：宴会蛋糕服务  
  >   
  >   - 问题描述：某位商⼈在餐厅举⾏⽣⽇宴会。餐桌上有⼀个点⼼盘，最多可容纳5块蛋糕，每个⼈（服务⽣或者来宾）每次只能放⼊/拿出1块蛋糕。服务⽣A负责向点⼼盘中放⼊抹茶蛋糕，服务⽣B负责向点⼼盘中放⼊芒果蛋糕。⽣⽇宴会上⼀共有6位男性来宾和4位⼥性来宾，男性来宾等待享⽤抹茶蛋糕，⼥性来宾则等待享⽤芒果蛋糕。如果盘中没有对应⼝味的蛋糕且点⼼盘没有放满，来宾会给相应的服务⽣发送⼀个请求服务信号，服务⽣收到信号后会放⼊1块蛋糕。
  > 
  > - 问题场景B：抽烟者与供应商
  >   
  >   - 问题描述：酒馆的吧台坐着3位抽烟者和1位供应商。每位抽烟者会不停地卷烟并抽掉，但是要卷起并抽掉⼀⽀烟，抽烟者需要三种材料：烟草、纸和胶⽔。三位抽烟者中，第1位拥有  
  >     烟草，第2位拥有纸，第3位拥有胶⽔。供应商会源源不断地提供三种材料，每次他会将两种随机的材料组合放在吧台的桌⾯上，拥有剩下那种材料的抽烟者，会⽴刻取⾛材料卷⼀根烟并抽掉它，然后给供应商发送⼀个完成信号，供应商就会放另外两种不同的材料组合在桌⾯上，这样的过程⼀直重复。

- 思路分析：

- 实验步骤：
* 实验结果展示：通过执行前述代码，可得下图结果。

### ------------------------- 实验任务3 -------------------------

- 任务要求：哲学家就餐问题
  
  - 问题场景
  
  > 假设有5位哲学家，他们在午餐时只能思考或吃⾯。午餐时，这些哲学家共⽤⼀个圆桌，每位哲学家都坐在⼀把指定的椅⼦上。在桌⼦上放着5根筷⼦，每两根筷⼦之间都放着⼀碗葱油⾯。下⾯是⼀些约束条件：  
  > 
  > - 当⼀位哲学家处于思考状态时，他对其他哲学家不会产⽣影响。 
  > 
  > - 当⼀位哲学家感到饥饿时，他会试图拿起与他相邻的两根筷⼦。  
  > 
  > - ⼀个哲学家⼀次只能拿起⼀根筷⼦，在拿到两根筷⼦之前不会放下⼿⾥的筷⼦。  
  > 
  > - 如果筷⼦在其他哲学家⼿⾥，则需要等待。  
  > 
  > - 当⼀个饥饿的哲学家同时拥有两根筷⼦时，他会开始吃⾯。  
  > 
  > - 吃完⾯后的哲学家会同时放下两根筷⼦，并开始思考。
  
  - ⼦任务1—简单解决⽅法
  
  > 同学们需要在实验6教程的代码环境下，创建多个线程来模拟哲学家就餐的场景。然后，同学们需要结合信号量来实现理论课教材（参⻅《操作系统概念》中⽂第9版第187⻚的内容）中给出的关于哲学家就餐问题的简单解决⽅法。最后，保存结果截图并说说你是怎么做的。
  > 注意：  
  > 
  > 1. 截图结果中不能出现饥饿/死锁，可以通过输出不同哲学家的状态信息，验证你使⽤教材的⽅法确实能解决哲学家就餐问题。  
  > 2. 请将你学号的后4位包含在其中⼀个哲学家线程的输出信息中，⽤作结果截图中的个⼈信息表征。
  
  - ⼦任务2—死锁应对策略
  
  > ⼦任务1的解决⽅案保证两个相邻的哲学家不能同时进⻝，但是这种⽅案可能导致死锁。请同学们描述⼦任务1解决⽅法中会导致死锁的场景，并将其复现出来。进⼀步地，请同学们在下述4种策略中选择1种，解决⼦任务1中的死锁问题，并在代码中实现。最后，保存结果截图并说说你的实现思路。
  > 
  > - 策略1：利⽤抽屉原理（鸽笼原理）。即允许最多4个哲学家同时坐在桌⼦上，保证⾄少有1位哲学家能吃到⾯。  
  > 
  > - 策略2：利⽤AND信号量机制或信号量保护机制。仅当哲学家的左右两⽀筷⼦都可⽤时，才允许他拿起筷⼦进餐（或者说哲学家必须在临界区内拿起两根筷⼦）。  
  > 
  > - 策略3：使⽤⾮对称的解决⽅案。即规定奇数号的哲学家先拿起他左边的筷⼦，然后再去拿他右边的筷⼦；⽽偶数号的哲学家则先拿起他右边的筷⼦，然后再去拿他左边的筷⼦。按照这⼀规定，将是1、2号哲学家竞争1号筷⼦，3、4号哲学家竞争3号筷⼦。即五个哲学家都竞争奇数号筷⼦，获得后，再去竞争偶数号筷⼦，最后总会有⼀个哲学家能获得两⽀筷⼦⽽进餐。
  > 
  > - 策略4：基于管程的解决⽅法。参考理论课教材（⻅《操作系统概念》中⽂第9版190-191⻚），采⽤类似策略2的思路，定义管程来控制筷⼦的分布，控制哲学家拿起筷⼦和放下筷⼦的顺序，确保两个相邻的哲学家不会同时⽤餐。

- 思路分析：

- 实验步骤：

- 实验结果展示：通过执行前述代码，可得下图结果。

### ------------------------- 实验任务4 -------------------------

- 任务要求：

- 思路分析：

- 实验步骤：

- 实验结果展示：通过执行前述代码，可得下图结果。

## Section 4 实验总结与心得体会

## Section 5 对实验的改进建议和意见

## Section 6 附录：参考资料清单
