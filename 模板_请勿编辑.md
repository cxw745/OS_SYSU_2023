# 本科生实验报告

实验课程: 操作系统原理实验

任课教师: 刘宁

实验题目: **从实模式到保护模式**

专业名称: 计算机科学与技术

学生姓名: **陈雪玮**

学生学号: **21307387**

实验地点: 实验中心D501

实验时间: 2023.4.1

## Section 1 实验概述

- 学习到如何从16位的实模式跳转到32位的保护模式，然后在平坦模式下运行32位程序。

- 学习到如何使用I/O端口和硬件交互，为后面保护模式编程打下基础。

- 完成四个实验任务。

## Section 2 预备知识与实验环境

该节总结实验需要用到的基本知识，以及主机型号、代码编译工具、重要三方库的版本号信息等。

- 预备知识：x86汇编语言程序设计、Linux系统命令行工具

- 实验环境：
  
  - 虚拟机版本/处理器型号：Ubuntu18.04、i386
  
  - 代码编辑环境：Linux
  
  - 代码编译工具：makefile、gcc等
  
  - 重要三方库信息：

## Section 2 实验任务

- 实验任务1：完成课后思考题第9题，并简单总结bootloader的作用是什么。

- 实验任务2：在实验任务1的基础上，完成课后思考题第10题。

- 实验任务3：完成课后思考题第11题。

- 实验任务4：在进入保护模式后，按照如下要求，编写并执行一个自己定义的32位汇编程序，要求简单说一说你的实现思路，并提供结果截图。   
  使用两种不同的自定义颜色和一个自定义的起始位置(x,y)，使得bootloader加载后，在显示屏坐标(x,y)处开始输出自己的学号+姓名拼音首字母缩写，要求相邻字符前景色和背景色必须是相互对调的。公告图片中提供了学号为21307233，姓名为宋小宝，自定义位置(12,12)的输出样式，仅供参考。代码实现框架可参考实验2和实验3的MBR程序。

## Section 3 实验步骤与实验结果

### ------------------------- 实验任务1 -------------------------

- 任务要求：重述实验题目的详细要求，可以以图片的形式展示。

- 思路分析：主要分析如何得到预期结果，有哪些要注意的地方等。

- 实验步骤：给出关键部分的代码实现/命令行的执行过程，辅以必要的文字描述（可从指导书上摘抄）。

命令行与代码块可以通过特殊背景进行区分，或者添加文本边框，建议在IDE 或者gedit中编辑好后再复制/粘贴，可以选出与实验任务直接相关的关键部分进行粘贴，不要整段复制，代码英文字体建议采用Consolas五号字。

sudo apt install binutils

sudo apt install gcc

下面是一个汇编程序实现过程调用的案例：

call *read_disk*

jmp 0x0000:0x7e00

jmp $

*read_disk:*

    mov ax, 0

    mov es, ax

    mov bx, 0x7e00

    mov ah, 0x02    

    mov al, 0x05    

times 510-($-$$) db 0

db 0x55, 0xaa

上面是深色背景的参考样式（直接从VSCode中复制得到），也可以采用下面的基于文字边框的浅色样式：

call read_disk

jmp 0x0000:0x7e00

jmp $

read_disk:

    mov ax, 0

    mov es, ax

    mov bx, 0x7e00

    mov ah, 0x02   

    mov al, 0x05   

times 510-($-$$) db 0

db 0x55, 0xaa

- 实验结果展示：通过执行前述代码，可得下图结果。图片建议居中放置，为了排除抄袭的嫌疑，建议图中包含一些个人信息（学号、姓名）等。

### ------------------------- 实验任务1 -------------------------

- 任务要求：完成课后思考题第9题，并简单总结bootloader的作用是什么。

- 思路分析：主要分析如何得到预期结果，有哪些要注意的地方等。

- 实验步骤：给出关键部分的代码实现/命令行的执行过程，辅以必要的文字描述（可从指导书上摘抄）。

*  实验结果展示：通过执行前述代码，可得下图结果。

### ------------------------- 实验任务2 -------------------------

- 任务要求：在实验任务1的基础上，完成课后思考题第10题。

- 思路分析：主要分析如何得到预期结果，有哪些要注意的地方等。

- 实验步骤：给出关键部分的代码实现/命令行的执行过程，辅以必要的文字描述（可从指导书上摘抄）。

**直接磁盘服务(Direct Disk Service——INT 13H)**

*  实验结果展示：通过执行前述代码，可得下图结果。

### ------------------------- 实验任务3 -------------------------

- 任务要求：完成课后思考题第11题。

- 思路分析：主要分析如何得到预期结果，有哪些要注意的地方等。

- 实验步骤：给出关键部分的代码实现/命令行的执行过程，辅以必要的文字描述（可从指导书上摘抄）。

**在四个关键步骤前设置标识符BREAK1、BREAK2、BREAK3、BREAK4。**

```nasm
;1.准备GDT，用lgdt指令加载GDTR信息。
BREAK1:
;空描述符
mov dword [GDT_START_ADDRESS+0x00],0x00
mov dword [GDT_START_ADDRESS+0x04],0x00  
;具体内容省略
;创建描述符，这是一个数据段，对应0~4GB的线性地址空间
;建立保护模式下的堆栈段描述符      
;建立保护模式下的显存描述符   
;创建保护模式下平坦模式代码段描述符
;初始化描述符表寄存器GDTR

;2.打开第21根地址线。
BREAK2:
in al,0x92                         ;南桥芯片内的端口 
or al,0000_0010B
out 0x92,al                        ;打开A20

;3.开启cr0的保护模式标志位。
BREAK3:
cli                                ;中断机制尚未工作
mov eax,cr0
or eax,1
mov cr0,eax                        ;设置PE位

;4.远跳转，进入保护模式。
BREAK4:
;以下进入保护模式
jmp dword CODE_SELECTOR:protect_mode_begin
```

**使用makefile进入gdb调试**

**在bootloader起始地址设置断点并执行、打开窗口并添加符号表**

**在四个关键步骤的标识处设置断点，并结合代码、寄存器的内容等来分析这4个步骤**

**1.准备GDT，用lgdt指令加载GDTR信息**。

查看GDT的5个段描述符的内容，与我们预期的相符。

使用的指令为`x/5xg 0x8800`，解释如下

结果如下图

**2.打开第21根地址线**。

**3.开启cr0的保护模式标志位**。

**4.远跳转，进入保护模式**。

地址转变如下，说明跳转成功，进入保护模式

*  实验结果展示：通过执行前述代码，可得下图结果。

### ------------------------- 实验任务4 -------------------------

- 任务要求：在进入保护模式后，按照如下要求，编写并执行一个自己定义的32位汇编程序，要求简单说一说你的实现思路，并提供结果截图。   
  使用两种不同的自定义颜色和一个自定义的起始位置(x,y)，使得bootloader加载后，在显示屏坐标(x,y)处开始输出自己的学号+姓名拼音首字母缩写，要求相邻字符前景色和背景色必须是相互对调的。公告图片中提供了学号为21307233，姓名为宋小宝，自定义位置(12,12)的输出样式，仅供参考。代码实现框架可参考实验2和实验3的MBR程序。

- 思路分析：主要分析如何得到预期结果，有哪些要注意的地方等。

- 实验步骤：给出关键部分的代码实现/命令行的执行过程，辅以必要的文字描述（可从指导书上摘抄）。

- 实验结果展示：通过执行前述代码，可得下图结果。

## Section 4 实验总结与心得体会

## Section 5 对实验的改进建议和意见

无

## Section 6 附录：参考资料清单

[INT13中断详解_aweth0me的博客-CSDN博客](https://blog.csdn.net/brainkick/article/details/7583727)

[gdb查看内存地址和栈中的值—查看虚函数表、函数地址_vscode gdb 查看一个地址附近的值_ztguang的博客-CSDN博客](https://blog.csdn.net/ztguang/article/details/51015760#:~:text=gdb%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80%E7%9A%84%E5%80%BC%EF%BC%9Aexamine%20%E7%AE%80%E5%86%99%20x-----%E4%BD%BF%E7%94%A8gdb%3E%20help%20x%20%E6%9D%A5%E6%9F%A5%E7%9C%8B%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%20x%2F,%28n%2Cf%2Cu%E4%B8%BA%E5%8F%AF%E9%80%89%E5%8F%82%E6%95%B0%29%20n%3A%20%E9%9C%80%E8%A6%81%E6%98%BE%E7%A4%BA%E7%9A%84%E5%86%85%E5%AD%98%E5%8D%95%E5%85%83%E4%B8%AA%E6%95%B0%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E4%BB%8E%E5%BD%93%E5%89%8D%E5%9C%B0%E5%9D%80%E5%90%91%E5%90%8E%E6%98%BE%E7%A4%BA%E5%87%A0%E4%B8%AA%E5%86%85%E5%AD%98%E5%8D%95%E5%85%83%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E4%B8%80%E4%B8%AA%E5%86%85%E5%AD%98%E5%8D%95%E5%85%83%E7%9A%84%E5%A4%A7%E5%B0%8F%E7%94%B1%E5%90%8E%E9%9D%A2%E7%9A%84u%E5%AE%9A%E4%B9%89%20f%EF%BC%9A%E6%98%BE%E7%A4%BA%E6%A0%BC%E5%BC%8F%20x%20%28hex%29%20%E6%8C%89%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E6%A0%BC%E5%BC%8F%E6%98%BE%E7%A4%BA%E5%8F%98%E9%87%8F%E3%80%82)
